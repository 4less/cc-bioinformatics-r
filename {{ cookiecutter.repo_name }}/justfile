# set shell to bash for consistent behavior
set shell := ["bash", "-c"]

# Install renv (if missing), initialize if needed, load project, restore, then snapshot explicitly
setup:
	Rscript -e 'if (!requireNamespace("renv", quietly = TRUE)) install.packages("renv"); if (!file.exists("renv/activate.R")) renv::init(bare = TRUE); renv::load(); renv::settings$snapshot.type("explicit"); if (file.exists("renv.lock")) renv::restore(prompt = FALSE); renv::snapshot(prompt = FALSE, type = "explicit")'

# Restore packages (assumes renv is already installed)
restore:
	Rscript -e "if (!requireNamespace('renv', quietly = TRUE)) install.packages('renv'); if (!file.exists('renv/activate.R')) renv::init(bare = TRUE); renv::load(); if (file.exists('renv.lock')) renv::restore(prompt = FALSE)"

# Snapshot current library state into renv.lock
snapshot:
	Rscript -e "renv::load(); renv::snapshot(prompt = FALSE, type = 'explicit')"

# Remove local renv library and lockfile (forces a fresh restore next time)
clean-renv:
	rm -rf renv/library renv/staging
	rm -f renv.lock

# Example placeholder for your pipeline; customize or add more recipes
run-pipeline:
	@echo "Add your pipeline command here, e.g.:"
	@echo "  nextflow run nf-core/ampliseq ...."
